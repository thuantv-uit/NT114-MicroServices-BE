name: Scan Pipeline

on:
  workflow_call:  # Designed to be called from another workflow (e.g., ci.yml)
    inputs:
      services:
        description: 'List of services to scan (comma-separated, default: all five)'
        required: false
        type: string
        default: 'board-service,card-service,column-service,notification-service,user-service'

jobs:
  build-and-scan:
    name: Build and Scan Docker Images with Trivy
    runs-on: ubuntu-latest
    outputs:
      datetime: ${{ steps.set-datetime.outputs.datetime }}

    strategy:
  matrix:
    service: >-
      ${{ 
        fromJson(
          inputs.services ? 
          format('["%s"]', join(split(inputs.services, ','), '","')) : 
          '["board-service","card-service","column-service","notification-service","user-service"]'
        ) 
      }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up date and time
        id: set-datetime
        run: |
          DATETIME=$(date +%Y%m%d-%H%M%S)
          echo "DATETIME=$DATETIME" >> $GITHUB_ENV
          echo "datetime=$DATETIME" >> $GITHUB_OUTPUT  # For job output

      - name: Build Docker image for ${{ matrix.service }}
        run: |
          docker build -t ${{ matrix.service }}:${{ env.DATETIME }} -f ${{ matrix.service }}/Dockerfile ${{ matrix.service }}
        env:
          DOCKER_BUILDKIT: 1

      - name: Create results directory
        run: mkdir -p trivy-results

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.service }}:${{ env.DATETIME }}'
          format: 'json'
          output: 'trivy-results/scan-results-${{ matrix.service }}-${{ env.DATETIME }}.json'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '1'  # Fail workflow if CRITICAL vulns found
          hide-progress: false

      - name: Verify scan results file for ${{ matrix.service }}
        run: |
          OUTPUT_FILE="trivy-results/scan-results-${{ matrix.service }}-${{ env.DATETIME }}.json"
          if [ -f "$OUTPUT_FILE" ]; then
            ls -l trivy-results/
          else
            echo "Error: Scan results file not found!"
            exit 1
          fi

      - name: Upload scan results as artifact for ${{ matrix.service }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results-${{ matrix.service }}-${{ env.DATETIME }}
          path: trivy-results/scan-results-${{ matrix.service }}-${{ env.DATETIME }}.json

  push-results:
    name: Push Scan Results to trivy-results Branch
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all scan results artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Push scan results to trivy-results branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATETIME: ${{ needs.build-and-scan.outputs.datetime }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git fetch origin
          git checkout -B trivy-results origin/trivy-results || git checkout -b trivy-results
          mkdir -p trivy-results
          rm -rf trivy-results/*  # Clean old files to avoid accumulation
          # Move files using shared DATETIME
          for service in board-service card-service column-service notification-service user-service; do
            ARTIFACT_PATH="artifacts/trivy-scan-results-${service}-${DATETIME}"
            if [ -d "$ARTIFACT_PATH" ]; then
              mv "$ARTIFACT_PATH"/*.json trivy-results/ || echo "No file for $service"
            fi
          done
          git add trivy-results/*
          git commit -m "Add new Trivy scan results (${DATETIME})" || echo "No changes to commit"
          git push origin trivy-results