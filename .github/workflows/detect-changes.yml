name: Detect Changed Services

on:
  workflow_call:
    outputs:
      any_changed:     ${{ jobs.detect.outputs.any_changed }}
      services_json:   ${{ jobs.detect.outputs.services_json }}
      services_list:   ${{ jobs.detect.outputs.services_list }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      any_changed:     ${{ steps.filter.outputs.any_changed }}
      services_json:   ${{ steps.set-list.outputs.services_json }}
      services_list:   ${{ steps.set-list.outputs.services_list }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            board-service: 'board-service/**'
            card-service: 'card-service/**'
            column-service: 'column-service/**'
            notification-service: 'notification-service/**'
            user-service: 'user-service/**'

      - name: Build dynamic list
        id: set-list
        run: |
          CHANGED=()
          [[ "${{ steps.filter.outputs.board-service }}" == "true" ]] && CHANGED+=("board-service")
          [[ "${{ steps.filter.outputs.card-service }}" == "true" ]] && CHANGED+=("card-service")
          [[ "${{ steps.filter.outputs.column-service }}" == "true" ]] && CHANGED+=("column-service")
          [[ "${{ steps.filter.outputs.notification-service }}" == "true" ]] && CHANGED+=("notification-service")
          [[ "${{ steps.filter.outputs.user-service }}" == "true" ]] && CHANGED+=("user-service")

          echo "services_json=$(printf '%s\n' "${CHANGED[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
          echo "services_list=$(IFS=','; echo "${CHANGED[*]}")" >> $GITHUB_OUTPUT
          echo "any_changed=$( [ ${#CHANGED[@]} -gt 0 ] && echo true || echo false )" >> $GITHUB_OUTPUT